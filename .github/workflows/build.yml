name: Build Cutefish Dock AppImage

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3

      # --------------------------
      # Install Dependencies
      # --------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake g++ make pkg-config git wget zip patchelf \
            qtbase5-dev qtbase5-private-dev \
            qtdeclarative5-dev qtquickcontrols2-5-dev \
            qttools5-dev libqt5x11extras5-dev \
            libkf5windowsystem-dev libkf5networkmanagerqt-dev \
            libnm-dev libpulse-dev libcanberra-dev \
            extra-cmake-modules imagemagick \
            libxcb-shape0-dev libxcb-icccm4-dev \
            libxcb-render-util0-dev libxcb-xfixes0-dev \
            squashfs-tools

      # --------------------------
      # Build FishUI
      # --------------------------
      - name: Build FishUI
        run: |
          git clone https://github.com/cutefishos/fishui.git
          cd fishui
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          sudo make install

      # --------------------------
      # Build Dock
      # --------------------------
      - name: Build Dock
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          make DESTDIR=$PWD/AppDir install

      # --------------------------
      # Desktop File
      # --------------------------
      - name: Desktop file
        run: |
          mkdir -p build/AppDir/usr/share/applications
          cat << EOF > build/AppDir/usr/share/applications/cutefish-dock.desktop
          [Desktop Entry]
          Type=Application
          Name=Cutefish Dock
          Exec=cutefish-dock
          Icon=cutefish-dock
          Categories=Utility;
          EOF

      # --------------------------
      # Download linuxdeployqt
      # --------------------------
      - name: Download linuxdeployqt
        run: |
          wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

      # --------------------------
      # Build initial AppImage
      # --------------------------
      - name: Build AppImage
        run: |
          cd build/AppDir
          ../../linuxdeployqt-continuous-x86_64.AppImage \
            usr/share/applications/cutefish-dock.desktop \
            -bundle-non-qt-libs \
            -qmldir=../../ \
            -extra-plugins=platforms/libqxcb.so \
            -verbose=2 \
            -appimage

      # --------------------------
      # Extract and Patch AppRun
      # --------------------------
      - name: Patch AppRun
        run: |
          cd build/AppDir
          APPIMAGE=$(ls *.AppImage)

          ./$APPIMAGE --appimage-extract

          cd squashfs-root

          rm AppRun

          cat << 'EOF' > AppRun
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"

          export QT_QPA_PLATFORM=xcb
          export QT_PLUGIN_PATH="$HERE/usr/plugins"
          export QML2_IMPORT_PATH="$HERE/usr/qml:$HERE/usr/lib/qt5/qml"
          export QT_QUICK_CONTROLS_STYLE=Basic

          exec "$HERE/usr/bin/cutefish-dock" "$@"
          EOF

          chmod +x AppRun

          mksquashfs . ../Cutefish_Dock_FIXED-x86_64.AppImage -noappend
          chmod +x ../Cutefish_Dock_FIXED-x86_64.AppImage

      # --------------------------
      # Upload
      # --------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: Cutefish_Dock_FIXED
          path: build/AppDir/Cutefish_Dock_FIXED-x86_64.AppImage
