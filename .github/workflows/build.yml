name: Build Cutefish Dock AppImage

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y \
            cmake g++ qtbase5-dev qttools5-dev qtdeclarative5-dev \
            qtquickcontrols2-5-dev \
            libqt5x11extras5-dev libkf5windowsystem-dev \
            libkf5networkmanagerqt-dev \
            libnm-dev libpulse-dev libcanberra-dev \
            extra-cmake-modules make pkg-config wget git imagemagick zip patchelf

      - name: Build FishUI
        run: |
          git clone https://github.com/cutefishos/fishui.git
          cd fishui
          mkdir build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX:PATH=/usr
          make -j$(nproc)
          sudo make install
          echo "FishUI built and installed"

      - name: Build Cutefish Dock
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          make DESTDIR=AppDir install
          mkdir -p AppDir/usr/bin
          cp AppDir/cutefish-dock/cutefish-dock AppDir/usr/bin/cutefish-dock
          echo "Cutefish Dock binary copied"

      - name: Create desktop file and icon
        run: |
          mkdir -p build/AppDir/usr/share/applications
          mkdir -p build/AppDir/usr/share/icons/hicolor/256x256/apps
          DESKTOP_FILE=build/AppDir/usr/share/applications/cutefish-dock.desktop
          echo "[Desktop Entry]" > "$DESKTOP_FILE"
          echo "Type=Application" >> "$DESKTOP_FILE"
          echo "Name=Cutefish Dock" >> "$DESKTOP_FILE"
          echo "Exec=cutefish-dock" >> "$DESKTOP_FILE"
          echo "Icon=cutefish-dock" >> "$DESKTOP_FILE"
          echo "Comment=CutefishOS application dock" >> "$DESKTOP_FILE"
          echo "Categories=Utility;" >> "$DESKTOP_FILE"

          # Placeholder icon
          convert -size 256x256 xc:none build/AppDir/usr/share/icons/hicolor/256x256/apps/cutefish-dock.png || true

      - name: Download linuxdeployqt
        run: |
          mkdir -p build/linuxdeployqt
          wget -O build/linuxdeployqt/linuxdeployqt-continuous-x86_64.AppImage \
            https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x build/linuxdeployqt/linuxdeployqt-continuous-x86_64.AppImage

      - name: Create AppRun environment file
        run: |
          mkdir -p build/AppDir
          cat << 'EOF' > build/AppDir/AppRun.env
          QT_QPA_PLATFORM=xcb
          QT_PLUGIN_PATH=$APPDIR/usr/lib/qt5/plugins
          QML2_IMPORT_PATH=$APPDIR/usr/lib/qt5/qml
          QT_QUICK_CONTROLS_STYLE=Basic
          EOF

      - name: Build AppImage with all libraries
        run: |
          cd build/AppDir
          # export env for linuxdeployqt
          export QT_QPA_PLATFORM=xcb
          export QT_PLUGIN_PATH=$APPDIR/usr/lib/qt5/plugins
          export QML2_IMPORT_PATH=$APPDIR/usr/lib/qt5/qml
          ../linuxdeployqt/linuxdeployqt-continuous-x86_64.AppImage \
            usr/share/applications/cutefish-dock.desktop \
            -qmldir=/usr/lib/x86_64-linux-gnu/qt5/qml \
            -qmlimport=/usr/lib/x86_64-linux-gnu/qt5/qml \
            -extra-plugins=platforms/libqxcb.so \
            -verbose=2 \
            -appimage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Cutefish_Dock.AppImage
          path: "build/AppDir/*.AppImage"
