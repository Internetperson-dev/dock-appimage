name: Build Cutefish Dock AppImage

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        set -ex
        sudo apt update
        sudo apt install -y \
          build-essential cmake git wget pkg-config \
          qtbase5-dev qtdeclarative5-dev qtquickcontrols2-5-dev \
          qttools5-dev qttools5-dev-tools qtbase5-private-dev \
          libqt5x11extras5-dev \
          libkf5windowsystem-dev libkf5networkmanagerqt-dev \
          libkf5screen-dev libkf5bluezqt-dev libkf5kio-dev \
          libxcb1-dev libxcb-shape0-dev libxcb-icccm4-dev \
          libcanberra-dev libpulse-dev libcanberra-pulse \
          modemmanager-qt-dev libqt5sensors5-dev \
          extra-cmake-modules imagemagick patchelf fuse \
          desktop-file-utils

    # ----------------------------
    # Build FishUI
    # ----------------------------
    - name: Build FishUI
      run: |
        set -ex
        git clone https://github.com/cutefishos/fishui.git
        cd fishui
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        make VERBOSE=1
        make DESTDIR=$GITHUB_WORKSPACE/build/AppDir install

    # ----------------------------
    # Build libcutefish (screen disabled)
    # ----------------------------
    - name: Build libcutefish
      run: |
        set -ex
        git clone https://github.com/cutefishos/libcutefish.git
        cd libcutefish
        sed -i 's/add_subdirectory(screen)//g' CMakeLists.txt
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        make VERBOSE=1
        make DESTDIR=$GITHUB_WORKSPACE/build/AppDir install

    # ----------------------------
    # Build Cutefish Dock
    # ----------------------------
    - name: Build Cutefish Dock
      run: |
        set -ex
        git clone https://github.com/cutefishos/dock.git
        cd dock
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
        make VERBOSE=1
        make DESTDIR=$GITHUB_WORKSPACE/build/AppDir install

    # ----------------------------
    # Desktop file + icon (VALID)
    # ----------------------------
    - name: Create desktop entry
      run: |
        set -ex
        mkdir -p build/AppDir/usr/share/applications
        mkdir -p build/AppDir/usr/share/icons/hicolor/256x256/apps

        cat > build/AppDir/usr/share/applications/cutefish-dock.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=Cutefish Dock
        Exec=cutefish-dock
        Icon=cutefish-dock
        Categories=Utility;System;
        Terminal=false
        EOF

        desktop-file-validate build/AppDir/usr/share/applications/cutefish-dock.desktop

        convert -size 256x256 xc:none \
          build/AppDir/usr/share/icons/hicolor/256x256/apps/cutefish-dock.png || true

    # ----------------------------
    # linuxdeployqt
    # ----------------------------
    - name: Download linuxdeployqt
      run: |
        set -ex
        wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
        chmod +x linuxdeployqt-continuous-x86_64.AppImage
        mv linuxdeployqt-continuous-x86_64.AppImage build/

    - name: Bundle AppImage
      run: |
        set -ex
        cd build/AppDir

        export QT_QPA_PLATFORM=xcb
        export QT_STYLE_OVERRIDE=fusion
        export QML2_IMPORT_PATH=/usr/lib/x86_64-linux-gnu/qt5/qml

        ../linuxdeployqt-continuous-x86_64.AppImage \
          usr/share/applications/cutefish-dock.desktop \
          -qmldir=/usr/lib/x86_64-linux-gnu/qt5/qml \
          -verbose=2 \
          -appimage

    # ----------------------------
    # Upload artifact
    # ----------------------------
    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: Cutefish-Dock-AppImage
        path: build/AppDir/*.AppImage
